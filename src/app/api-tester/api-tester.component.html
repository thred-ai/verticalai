<div
  class="w-100 h-100 d-flex flex-column justify-content-between align-items-center"
  style="overflow: hidden"
>
  <div class="p-3 w-100 d-flex justify-content-between align-items-center">
    <div class="h-100 d-flex justify-content-center align-content-center">
      <button
        class="btn bg-orange border-0 rounded fw-bold text-white d-flex justify-content-between align-content-center me-1 p-2 my-auto"
        (click)="run()"
      >
        <!-- (click)="edited ? save() : publish(workflow)"
          [disabled]="loading" -->

        <mat-icon class="fw-bold" style="aspect-ratio: 1">
          play_arrow
        </mat-icon>
      </button>
      <button
        class="btn bg-orange border-0 rounded fw-bold text-white d-flex justify-content-between align-content-center ms-1 p-2 my-auto"
        (click)="loadingMode = 0"
      >
        <!-- (click)="edited ? save() : publish(workflow)"
          [disabled]="loading" -->

        <mat-icon class="fw-bold" style="aspect-ratio: 1"> stop </mat-icon>
      </button>
    </div>
  </div>

  <as-split class="w-100 h-100" class="horizontal-terminal" direction="vertical">
    <as-split-area class="horizontal-terminal" [size]="70">
      <div
        class="w-100 d-flex flex-column justify-content-start align-items-center p-2 h-100"
        style="overflow-y: scroll;"
      >
        <div class="w-100" *ngIf="model">
          <ng-container *ngFor="let chat of chats">
            <ng-container
              *ngTemplateOutlet="
                chatItem;
                context: { $implicit: { chat, typing: false } }
              "
            ></ng-container>
          </ng-container>

          <ng-container *ngIf="loadingMode > 1">
            <ng-container
              *ngTemplateOutlet="
                chatItem;
                context: {
                  $implicit: { chat: { type: 'system', msg: '' }, typing: true }
                }
              "
            ></ng-container>
          </ng-container>

          <!-- <ng-container *ngIf="!image; else tabs"> -->
          <!-- <ng-container *ngTemplateOutlet="tabs"></ng-container> -->
          <!-- </ng-container> -->

          <ng-template #tabs>
            <verticalai-textbox
              class="w-100"
              *ngIf="loadingMode == 0; else loader"
              [simplify]="true"
              [editable]="false"
              [bgColor]="'transparent'"
              [value]="prettyResponse"
              [type]="'text'"
              [placeholder]="'Output Text'"
            >
            </verticalai-textbox>

            <!-- <mat-tab-group
          mat-stretch-tabs
          #menu
          class="w-100"
          dynamicHeight
          animationDuration="0ms"
        >
          <mat-tab class="tab" *ngIg="!image">
            <ng-template mat-tab-label>
              <span class="text-light"> Image </span>
            </ng-template>

            <ng-template matTabContent>
              <div
                class="w-100 rounded py-2 bg-black mb-5"
                style="border: #1f1f1f solid 1px"
                *ngIf="image"
              >
                <img
                  *ngIf="!loading; else loader"
                  class="w-100 h-100"
                  style="object-fit: contain"
                  [src]="image | safeImgUrl"
                />
              </div>
            </ng-template>
          </mat-tab>

          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="text-light"> Pretty </span>
            </ng-template>

            <ng-template matTabContent>
              <div
                class="w-100 rounded bg-black mb-5"
                style="
                  height: 400px;
                  border: #1f1f1f solid 1px;
                  overflow-y: hidden
                "
              >
                <verticalai-textbox
                  class="w-100"
                  *ngIf="!loading; else loader"
                  [simplify]="true"
                  [editable]="false"
                  [bgColor]="'transparent'"
                  [value]="prettyResponse"
                  [type]="'text'"
                  [placeholder]="'Output Text'"
                >
                </verticalai-textbox>
              </div>
            </ng-template>
          </mat-tab>

          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="text-light"> Raw </span>
            </ng-template>
            <ng-template matTabContent>
              <ng-container *ngTemplateOutlet="bodyFields"></ng-container>
            </ng-template>
          </mat-tab>
        </mat-tab-group> -->
          </ng-template>
        </div>
      </div>
    </as-split-area>

    <as-split-area
      class="vertical-terminal bg-black"
      [size]="30"
    >
      <div class="w-100 h-100">
        <verticalai-textbox
          class="h-100"
          [value]="request"
          [type]="'text'"
          [disabled]="false"
          [bgColor]="'#000'"
          [defaultValue]="''"
          [placeholder]="'Type something...'"
          (changed)="request = $event"
        >
        </verticalai-textbox>
      </div>
    </as-split-area>
  </as-split>
</div>

<ng-template #bodyFields>
  <div
    class="w-100 h-100 rounded py-2 bg-black"
    style="border: #1f1f1f solid 1px"
  >
    <ngs-code-editor
      *ngIf="loadingMode == 0; else loader"
      style="width: 100%; height: 100%"
      [theme]="'hc-black'"
      [readOnly]="true"
      [codeModel]="{
        language: 'json',
        uri: 'json' + '-response',
        value: response
      }"
      [options]="{
        contextmenu: false,
        minimap: {
          enabled: false
        },
        scrollbar: {
          vertical: 'hidden'
        },
        overviewRulerBorder: false,
        overviewRulerLanes: 0,
        renderLineHighlight: 'none',
        hideCursorInOverviewRuler: true
      }"
    >
    </ngs-code-editor>
  </div>
</ng-template>

<ng-template #loader>
  <div
    class="w-100 h-100 py-5 d-flex flex-column justify-content-center align-items-center"
  >
    <verticalai-loader
      [mode]="'light'"
      [text]="'Sending...'"
    ></verticalai-loader>
  </div>
</ng-template>

<ng-template #chatItem let-chatInfo>
  <div
    class="d-flex justify-content-center align-content-start w-100 py-3 animate__animated animate__fadeIn"
  >
    <div
      class="rounded-circle icons bg-pink ms-0 mt-1"
      style="
        border-style: solid;
        border-width: 0.2rem;
        border-color: rgb(255, 232, 248);
        width: fit-content;
        height: 50px;
      "
    >
      <img
        *ngIf="user && model"
        class="h-100 p-0 m-auto rounded-circle"
        style="object-fit: cover; aspect-ratio: 1"
        [src]="
          chatInfo.chat.type == 'user' && user && user.url
            ? user.url
            : model.displayUrl
        "
      />
    </div>
    <div class="w-100 ms-3 mb-0" style="max-width: 700px">
      <div class="w-100">
        <verticalai-textbox
          *ngIf="!chatInfo.typing; else typing"
          [value]="chatInfo.chat.msg"
          [type]="'text'"
          [disabled]="true"
          [corners]="'10'"
          [bgColor]="'#1F1F1F'"
          [defaultValue]="''"
          [placeholder]="'Nothing to show'"
          [maxHeight]="0"
        >
        </verticalai-textbox>
        <ng-template #typing>
          <verticalai-textbox
            [animation]="'typing'"
            [type]="'text'"
            [disabled]="true"
            [corners]="'10'"
            [bgColor]="'#1F1F1F'"
            [defaultValue]="''"
            [placeholder]="''"
            [maxHeight]="0"
          >
          </verticalai-textbox>
        </ng-template>
      </div>
    </div>
  </div>
</ng-template>
