<div
  class="w-100 h-100 d-flex flex-column justify-content-between align-items-center secondary-background"
  cdkDrag
  cdkDragRootElement=".cdk-overlay-pane"
  style="overflow: hidden"
>


  <div
    class="primary-background w-100 d-flex justify-content-end align-items-center px-3"
    style="height: 50px"
    cdkDragHandle
  >
    <div
      class="primary-text"
      style="aspect-ratio: 1"
      role="button"
      (click)="dialogRef.close()"
    >
      <mat-icon> close </mat-icon>
    </div>
  </div>
  <as-split
    class="w-100 h-100"
    class="horizontal-terminal"
    direction="vertical"
  >
    <as-split-area class="horizontal-terminal" [size]="70">
      <div class="w-100 h-100 position-relative p-3">
        <div
          class="w-100 d-flex flex-column justify-content-start align-items-center p-2 py-3 h-100"
          style="overflow-y: scroll"
        >
          <div class="w-100" *ngIf="model">
            <ng-container *ngFor="let chat of chats">
              <ng-container
                *ngTemplateOutlet="
                  chatItem;
                  context: { $implicit: { chat, typing: false } }
                "
              ></ng-container>
            </ng-container>

            <ng-container *ngIf="loadingMode > 1">
              <ng-container
                *ngTemplateOutlet="
                  chatItem;
                  context: {
                    $implicit: {
                      chat: { type: 'system', msg: '' },
                      typing: true
                    }
                  }
                "
              ></ng-container>
            </ng-container>

            <!-- <ng-container *ngIf="!image; else tabs"> -->
            <!-- <ng-container *ngTemplateOutlet="tabs"></ng-container> -->
            <!-- </ng-container> -->

            <ng-template #tabs>
              <verticalai-textbox
                class="w-100"
                *ngIf="loadingMode == 0; else loader"
                [simplify]="true"
                [editable]="false"
                [value]="prettyResponse"
                [type]="'text'"
                [placeholder]="'Output Text'"
              >
              </verticalai-textbox>

              <!-- <mat-tab-group
          mat-stretch-tabs
          #menu
          class="w-100"
          dynamicHeight
          animationDuration="0ms"
        >
          <mat-tab class="tab" *ngIg="!image">
            <ng-template mat-tab-label>
              <span class="primary-text  "> Image </span>
            </ng-template>

            <ng-template matTabContent>
              <div
                class="w-100 rounded py-2 primary-background mb-5"
                style="border: #1f1f1f solid 1px"
                *ngIf="image"
              >
                <img
                  *ngIf="!loading; else loader"
                  class="w-100 h-100"
                  style="object-fit: contain"
                  [src]="image | safeImgUrl"
                />
              </div>
            </ng-template>
          </mat-tab>

          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="primary-text  "> Pretty </span>
            </ng-template>

            <ng-template matTabContent>
              <div
                class="w-100 rounded primary-background mb-5"
                style="
                  height: 400px;
                  border: #1f1f1f solid 1px;
                  overflow-y: hidden
                "
              >
                <verticalai-textbox
                  class="w-100"
                  *ngIf="!loading; else loader"
                  [simplify]="true"
                  [editable]="false"
                  [bgColor]="'transparent'"
                  [value]="prettyResponse"
                  [type]="'text'"
                  [placeholder]="'Output Text'"
                >
                </verticalai-textbox>
              </div>
            </ng-template>
          </mat-tab>

          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="primary-text  "> Raw </span>
            </ng-template>
            <ng-template matTabContent>
              <ng-container *ngTemplateOutlet="bodyFields"></ng-container>
            </ng-template>
          </mat-tab>
        </mat-tab-group> -->
            </ng-template>
          </div>
        </div>
        <div
          class="p-2 d-flex justify-content-between align-items-center position-absolute"
          style="z-index: 100; bottom: 0"
        >
          <div
            class="h-100 d-flex justify-content-center align-content-center rounded-10"
          >
            <button
              class="btn bg-orange shadow-0 border-0 fw-bold text-white d-flex justify-content-between align-content-center p-1 me-1 my-auto"
              (click)="run()"
            >
              <!-- (click)="edited ? save() : publish(workflow)"
              [disabled]="loading" -->

              <mat-icon class="fw-bold" style="aspect-ratio: 1">
                play_arrow
              </mat-icon>
            </button>
            <button
              class="btn bg-orange shadow-0 border-0 fw-bold text-white d-flex justify-content-between align-content-center p-1 ms-1 my-auto"
              (click)="loadingMode = 0"
            >
              <!-- (click)="edited ? save() : publish(workflow)"
              [disabled]="loading" -->

              <mat-icon class="fw-bold" style="aspect-ratio: 1">
                stop
              </mat-icon>
            </button>
          </div>
        </div>
      </div>
    </as-split-area>

    <as-split-area class="vertical-terminal section-background" [size]="30">
      <div class="w-100 h-100">
        <verticalai-textbox
          class="h-100"
          [value]="request"
          [type]="'text'"
          [bgColor]="'var(--sectionBackgroundColor)'"
          [disabled]="false"
          [defaultValue]="''"
          [placeholder]="'Type something...'"
          (changed)="request = $event"
        >
        </verticalai-textbox>
      </div>
    </as-split-area>
  </as-split>
</div>

<ng-template #bodyFields>
  <div
    class="w-100 h-100 rounded py-2 primary-background"
    style="border: #1f1f1f solid 1px"
  >
    <ngs-code-editor
      *ngIf="loadingMode == 0; else loader"
      style="width: 100%; height: 100%"
      [theme]="'hc-black'"
      [readOnly]="true"
      [codeModel]="{
        language: 'json',
        uri: 'json' + '-response',
        value: response
      }"
      [options]="{
        contextmenu: false,
        minimap: {
          enabled: false
        },
        scrollbar: {
          vertical: 'hidden'
        },
        overviewRulerBorder: false,
        overviewRulerLanes: 0,
        renderLineHighlight: 'none',
        hideCursorInOverviewRuler: true
      }"
    >
    </ngs-code-editor>
  </div>
</ng-template>

<ng-template #loader>
  <div
    class="w-100 h-100 py-5 d-flex flex-column justify-content-center align-items-center"
  >
    <verticalai-loader
      [mode]="'light'"
      [text]="'Sending...'"
    ></verticalai-loader>
  </div>
</ng-template>

<ng-template #chatItem let-chatInfo>
  <div
    class="d-flex justify-content-center align-content-start w-100 py-3 animate__animated animate__fadeIn"
  >
    <div
      class="rounded-circle icons primary-background ms-0 mt-1"
      style="
        border-style: solid;
        border-width: 0.2rem;
        border-color: var(--primarySectionHoverColor);
        width: fit-content;
        height: 50px;
      "
    >
      <img
        *ngIf="user && model"
        class="h-100 p-0 m-auto rounded-circle"
        style="object-fit: cover; aspect-ratio: 1"
        [src]="
          chatInfo.chat.type == 'user' && user && user.url
            ? user.url
            : model.displayUrl
        "
      />
    </div>
    <div class="w-100 ms-3 mb-0" style="max-width: 700px">
      <div
        class="w-100 rounded-10 primary-background shadow d-flex justify-content-between align-items-end"
      >
        <ng-container *ngIf="!chatInfo.typing; else typing">
          <verticalai-textbox
            #box
            [value]="chatInfo.chat.msg"
            [type]="'text'"
            [corners]="'rounded-10'"
            [placeholder]="'Nothing to show'"
            [maxHeight]="0"
            [bgColor]="'var(--primaryBackgroundColor)'"
            style="pointer-events: none"
          >
          </verticalai-textbox>
          <div class="p-1 primary-text" role="button" (click)="copy(box.value)">
            <mat-icon style="font-size: 18px"> content_copy </mat-icon>
          </div>
        </ng-container>

        <ng-template #typing>
          <verticalai-textbox
            [animation]="'typing'"
            [type]="'text'"
            [corners]="'rounded-10'"
            [maxHeight]="0"
            [bgColor]="'var(--primaryBackgroundColor)'"
            style="pointer-events: none"
          >
          </verticalai-textbox>
        </ng-template>
      </div>
    </div>
  </div>
</ng-template>
